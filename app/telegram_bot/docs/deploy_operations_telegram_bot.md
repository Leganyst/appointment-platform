# Инструкция по развертыванию и эксплуатации (Telegram‑бот)

Документ описывает развертывание компонента `app/telegram_bot`, его конфигурацию, эксплуатацию, мониторинг и типовые операции сопровождения.

## Предварительные требования

### Внешние зависимости

- Доступ к Telegram Bot API (для long polling).
- Доступность core‑сервисов по gRPC:
  - `Identity` (endpoint `IDENTITY_GRPC_ENDPOINT`)
  - `Calendar` (endpoint `CALENDAR_GRPC_ENDPOINT`)

Без работающих core‑сервисов бот сможет принимать команды, но большинство функций будет деградировать с сообщениями о недоступности.

### ПО и окружение

- Python 3.x и виртуальное окружение (venv/poetry/pipenv — на выбор).
- Установленные зависимости из `requirements.txt`.

## Конфигурация

Все параметры задаются через переменные окружения (см. `src/telegram_bot/config.py` и `.env.example`).

Обязательные/ключевые:
- `BOT_TOKEN` — токен Telegram‑бота.
- `IDENTITY_GRPC_ENDPOINT` — адрес Identity сервиса, например `localhost:50051`.
- `CALENDAR_GRPC_ENDPOINT` — адрес Calendar сервиса, например `localhost:50052`.

Параметры надёжности:
- `GRPC_DEADLINE_SEC` — таймаут gRPC запросов в секундах (по умолчанию 3.0).
- `BOT_LOG_LEVEL` — уровень логирования (`INFO`, `DEBUG`, ...).

Параметры шифрования (gRPC):
- `GRPC_TLS` — `true/false`, использовать ли TLS для канала бот → core.
- `GRPC_ROOT_CERT` — путь к root CA сертификату (если требуется валидация сервера).

Примечание: `BOT_DATABASE_URL` присутствует в конфиге, но по умолчанию БД не инициализируется в `src/telegram_bot/main.py`. Подключение БД требует отдельной доработки (см. техническое руководство).

## Развертывание (локально/на сервере)

### Подготовка окружения

Из каталога `app/telegram_bot`:

1. Создайте `.env` на основе `.env.example` и заполните значения.
2. Установите зависимости:
   - `pip install -r requirements.txt`

### Запуск

Проект запускается как модуль Python. Варианты:

1) Через `PYTHONPATH`:
- `PYTHONPATH=src python -m telegram_bot.main`

2) Через установленный пакет в venv (editable):
- `pip install -e .` (если добавлен `pyproject.toml/setup.py`) и затем `python -m telegram_bot.main`

Важно: бот использует **long polling**, поэтому в одной среде исполнения должен быть **один активный экземпляр**, чтобы избежать конкурирующего получения апдейтов.

### Запуск как сервис (рекомендации)

Для эксплуатации используйте менеджер процессов:
- `systemd` (Linux), либо
- контейнеризацию (Docker) и перезапуск через оркестратор.

Критично обеспечить:
- автоперезапуск при падении процесса;
- доставку логов в централизованное хранилище (stdout/journald/лог‑агент).

## Эксплуатация

### Наблюдаемость (логирование)

- Логирование включается в `src/telegram_bot/main.py` через `logging.basicConfig`.
- Уровень задаётся `BOT_LOG_LEVEL`.
- Для трассировки запросов к core в gRPC metadata прокидывается `x-corr-id`; корреляция полезна при разборе инцидентов по цепочке «бот → core».

### Типовые проверки работоспособности

- Бот отвечает на `/start`.
- При рабочем `Identity` бот успешно создаёт/находит пользователя и показывает меню.
- При рабочем `Calendar` работают сценарии каталога и бронирования.
- При недоступности core бот возвращает пользовательские сообщения об ошибке (см. `src/telegram_bot/services/errors.py`).

### Обновление и откат

Рекомендуемый безопасный порядок обновления:
1. Обновить/перекатить core‑сервисы (если менялись контракты или поведение).
2. Обновить бот.
3. Проверить `/start` и основные сценарии клиента.

Если обновление затрагивает protobuf‑контракты:
- убедитесь, что `src/telegram_bot/generated/*` соответствует `api/proto/*` и версии `grpcio`;
- при несовместимости версии `grpcio` возможны ошибки импорта generated‑кода (см. техническое руководство).

Откат:
- вернуть предыдущую версию кода/образа;
- восстановить прежние переменные окружения, если они менялись.

## Безопасность в эксплуатации

- Храните `BOT_TOKEN` и TLS‑материалы в секрет‑хранилище (не в репозитории).
- Включайте TLS (`GRPC_TLS=true`) при межсетевом взаимодействии бот ↔ core.
- Ограничьте сетевую доступность gRPC endpoints (ACL/Firewall/NetworkPolicy) только для подсетей/хостов, где запущен бот.

## Резервное копирование и восстановление

### Что бэкапить

- Данные записей/слотов/профилей находятся в core‑части, поэтому регулярные бэкапы должны выполняться на уровне БД core‑сервисов.
- Для бота отдельно важно обеспечивать:
  - резервирование конфигурации и секретов (в системе управления секретами);
  - возможность быстро развернуть новый экземпляр бота.

### Восстановление после сбоя

1. Убедиться в доступности core‑сервисов и их БД.
2. Восстановить секреты/конфигурацию (включая `BOT_TOKEN`).
3. Запустить бот (процесс‑менеджер должен поднять сервис).
4. Проверить `/start` и базовые сценарии.

Примечание: так как FSM хранится в памяти, после рестарта текущие пользовательские диалоги не сохраняются; пользователю требуется повторить шаги (обычно достаточно заново начать с `/start`).
