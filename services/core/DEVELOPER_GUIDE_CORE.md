# Техническое руководство разработчика — сервис `core`

Документ описывает устройство сервиса `core`, структуру кода, ключевые зависимости, правила работы с API/моделями и рекомендации по внесению изменений.

## 1. Назначение и границы ответственности

`core` — gRPC‑сервис календарного домена платформы записи:
- расписания провайдеров (повторяющиеся правила),
- материализация слотов в окне времени,
- бронирования/отмена/проверки доступности,
- каталог услуг,
- базовая идентификация пользователя по Telegram ID (для внешних клиентов).

В `core` нет UI и нет встроенной аутентификации клиента; обычно аутентификацию/авторизацию обеспечивает внешний слой (gateway/бот) или добавляется через gRPC interceptor.

## 2. Структура проекта

Основные каталоги:
- `cmd/main.go` — bootstrap: конфиг, БД, миграции, gRPC‑сервер.
- `internal/api/**` — `.proto` и сгенерированные `*.pb.go`.
- `internal/service/*` — реализации gRPC‑сервисов (`CalendarService`, `IdentityService`).
- `internal/repository/*` — интерфейсы репозиториев и реализация на GORM.
- `internal/model/*` — GORM‑модели (схема БД) и `AutoMigrate`.
- `internal/config` — загрузка конфигурации из env.
- `internal/db` — инициализация GORM (DSN, UTC‑NowFunc, пул соединений).
- `internal/utils` — чистая логика времени/правил повторений (с тестами).
- `internal/calendar` — общие утилиты (пагинация/валидация TG‑пользователя), частично не задействованы в основных сервисах.

## 3. Технологии и зависимости

- Go: версия из `go.mod` (`go 1.25.0`).
- gRPC: `google.golang.org/grpc`.
- Protobuf: `google.golang.org/protobuf`.
- ORM: GORM (`gorm.io/gorm`), драйвер Postgres (`gorm.io/driver/postgres`).
- UUID: `github.com/google/uuid`.

## 4. Модель данных (схема) и миграции

### 4.1 Модели

Модели описаны в `internal/model/*`, миграция запускается на старте (`internal/model/migrate.go`).

Ключевые сущности:
- `User` (`users`): `telegram_id` уникален; поле `note` используется как хранилище `username`.
- `Role`/`UserRole` (`roles`, `user_roles`): политика “1 роль на пользователя”.
- `Client` (`clients`): создаётся/гарантируется при регистрации.
- `Provider` (`providers`): создаётся при роли `provider`.
- `Service`/`ProviderService` (`services`, `provider_services`): каталог + связка many‑to‑many.
- `Schedule` (`schedules`): JSONB‑правило повторений + границы дат + `time_zone`.
- `TimeSlot` (`time_slots`): материализованные слоты, статусы `planned/booked/cancelled`.
- `Booking` (`bookings`): статус `confirmed/cancelled`, `slot_id` уникален.
- `Event` (`events`): модель аудита заведена, но запись событий в текущих сервисах не реализована.

### 4.2 `pgcrypto` и UUID

В моделях используется `default:gen_random_uuid()`, поэтому в Postgres обычно нужен `pgcrypto`:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

### 4.3 `AutoMigrate` и эксплуатационные риски

`AutoMigrate` на старте удобен для разработки, но при нескольких репликах может создавать гонки и увеличивать время запуска. Для production рекомендуется вынести миграции в отдельный управляемый этап (job/step) и отключить автомиграции в runtime.

## 5. gRPC API: где смотреть и как менять

### 5.1 Контракты

Файлы `.proto`:
- `internal/api/common/v1/common.proto`
- `internal/api/identity/v1/identity.proto`
- `internal/api/calendar/v1/calendar.proto`

Сгенерированные файлы уже лежат рядом с `.proto`.

### 5.2 Регенерация protobuf

Команда регенерации:

```bash
protoc \
  -I . \
  --go_out=. --go_opt=paths=source_relative \
  --go-grpc_out=. --go-grpc_opt=paths=source_relative \
  internal/api/common/v1/common.proto \
  internal/api/identity/v1/identity.proto \
  internal/api/calendar/v1/calendar.proto
```

### 5.3 Реализации сервисов

- `internal/service/identity_service.go`:
  - регистрация/обновление контактов по `telegram_id`,
  - назначение роли (создание `providers` при роли `provider`),
  - поиск провайдера по телефону (нормализация до цифр).
- `internal/service/calendar_service.go`:
  - выдача слотов с материализацией по расписаниям,
  - бронирование с транзакциями и конфликт‑проверками,
  - отмены (одиночная и массовая),
  - CRUD расписаний/слотов,
  - каталог услуг.

## 6. Ключевые бизнес‑инварианты и “острые места”

### 6.1 Идемпотентность и дедупликация слотов

Материализация слотов из расписаний выполняется “лениво” в окне `ListFreeSlots` и дедуплицируется в памяти по ключу `(service_id, starts_at, ends_at)` внутри транзакции.

Важно:
- при горизонтальном масштабировании без уникального индекса на `time_slots` возможны дубли при параллельной материализации разными репликами (память‑дедупликация работает только в рамках одной транзакции/процесса).
- если требуется строгая гарантия отсутствия дублей — добавьте уникальное ограничение на уровне БД (ключ выбирается по требованиям домена).

### 6.2 Конкурентное бронирование

`CreateBooking`:
- блокирует строку слота `FOR UPDATE`;
- проверяет статус слота;
- проверяет пересечения по времени (клиент и провайдер) только по `confirmed`;
- создаёт `bookings` и переводит слот в `booked` в одной транзакции.

Схемная гарантия:
- уникальный индекс `bookings.slot_id` защищает от двух бронирований на один слот.

### 6.3 Время и таймзоны

- В БД время слотов хранится как `timestamp with time zone`.
- GORM настроен на `UTC` через `NowFunc`.
- Расписания хранят `time_zone`; при развёртывании правило интерпретируется в указанной TZ и затем переводится в UTC.

### 6.4 Телефон и поиск провайдера

- Телефон нормализуется до цифр на уровне репозитория пользователя (`normalizePhone`).
- Поиск провайдера по телефону требует наличие роли `provider`; иначе возвращается `NotFound`.

## 7. Запуск, тесты, отладка

### 7.1 Локальный запуск

1) Поднять Postgres и включить `pgcrypto`.
2) Экспортировать `DB_*` переменные.
3) `go run ./cmd`

### 7.2 Тесты

```bash
go test ./...
```

Примечание: часть тестов использует SQLite in‑memory для проверки SQL‑логики сервисных методов (например, массовая отмена).

### 7.3 Диагностика API

Reflection включён, можно использовать `grpcurl`:

```bash
grpcurl -plaintext localhost:50051 list
grpcurl -plaintext localhost:50051 list calendar.v1.CalendarService
grpcurl -plaintext localhost:50051 list identity.v1.IdentityService
```

## 8. Рекомендации по внесению изменений

### 8.1 Добавление нового RPC

1) Обновить `.proto`.
2) Регенерировать `*.pb.go`.
3) Реализовать метод в `internal/service/*`.
4) При необходимости:
   - добавить/обновить модели `internal/model/*`;
   - добавить методы репозиториев `internal/repository/*`;
   - добавить тесты (сфокусированные на логике).

### 8.2 Изменение схемы

- Изменения в моделях, влияющие на данные, стоит сопровождать управляемыми миграциями (а не только `AutoMigrate`) при работе в production.
- Любые новые ограничения/индексы должны соответствовать реальным запросам репозиториев и инвариантам домена.

### 8.3 Безопасность

- Изменения, влияющие на права доступа, лучше реализовывать через единый механизм (interceptor) и явную модель “caller → права → ресурсы”.
- Не добавлять чувствительные данные в логи; маскировать телефон/идентификаторы при необходимости.
