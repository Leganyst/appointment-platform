syntax = "proto3";

package calendar.v1;

option go_package = "github.com/Leganyst/appointment-platform/internal/api/calendar/v1;calendarpb";

import "google/protobuf/timestamp.proto";
import "internal/api/common/v1/common.proto";

// ==== Запросы/ответы: слоты ====

// Запрос свободных слотов в указанном интервале.
message ListFreeSlotsRequest {
  string provider_id = 1;
  string service_id  = 2;

  google.protobuf.Timestamp start = 3;
  google.protobuf.Timestamp end   = 4;

  int32 page      = 5; // номер страницы, начиная с 1
  int32 page_size = 6; // размер страницы
}

message ListFreeSlotsResponse {
  repeated common.v1.Slot slots       = 1;
  int32                total_count = 2;
}

// ==== Запросы/ответы: бронирование ====

// Создание бронирования.
message CreateBookingRequest {
  string client_id = 1;
  string slot_id   = 2;
  string comment   = 3;
}

message CreateBookingResponse {
  common.v1.Booking booking = 1;
}

// Получение информации о бронировании.
message GetBookingRequest {
  string booking_id = 1;
}

message GetBookingResponse {
  common.v1.Booking booking = 1;
}

// Отмена бронирования.
message CancelBookingRequest {
  string booking_id = 1;
  string reason     = 2;
}

message CancelBookingResponse {
  common.v1.Booking booking = 1;
}

// Список бронирований клиента за период.
message ListBookingsRequest {
  string client_id = 1;

  google.protobuf.Timestamp from = 2;
  google.protobuf.Timestamp to   = 3;

  int32 page      = 4;
  int32 page_size = 5;
}

message ListBookingsResponse {
  repeated common.v1.Booking bookings   = 1;
  int32                 total_count = 2;
}

// ==== Запросы/ответы: расписания провайдера ====

// Получение расписаний провайдера.
message ListProviderSchedulesRequest {
  string provider_id = 1;
}

message ListProviderSchedulesResponse {
  repeated common.v1.ProviderSchedule schedules = 1;
}

// Создание расписания провайдера (правило повторения).
message CreateProviderScheduleRequest {
  string provider_id = 1;
  common.v1.ProviderSchedule schedule = 2; // rule, timezone, dates
}

message CreateProviderScheduleResponse {
  common.v1.ProviderSchedule schedule = 1;
}

// Обновление расписания.
message UpdateProviderScheduleRequest {
  string schedule_id = 1;
  common.v1.ProviderSchedule schedule = 2; // новые значения
}

message UpdateProviderScheduleResponse {
  common.v1.ProviderSchedule schedule = 1;
}

// Удаление расписания.
message DeleteProviderScheduleRequest {
  string schedule_id = 1;
}

message DeleteProviderScheduleResponse {}

// ==== Запросы/ответы: CRUD слотов ====

message CreateSlotRequest {
  string provider_id = 1;
  string service_id = 2;
  common.v1.TimeRange range = 3;
}

message CreateSlotResponse {
  common.v1.Slot slot = 1;
}

message UpdateSlotRequest {
  string slot_id = 1;
  string service_id = 2;
  common.v1.TimeRange range = 3;
  common.v1.SlotStatus status = 4;
}

message UpdateSlotResponse {
  common.v1.Slot slot = 1;
}

message DeleteSlotRequest {
  string slot_id = 1;
}

message DeleteSlotResponse {}

// ==== Сервис календаря ====

// Основной gRPC-сервис календарного ядра.
service CalendarService {
  // Получение свободных слотов в указанном интервале.
  rpc ListFreeSlots (ListFreeSlotsRequest) returns (ListFreeSlotsResponse);

  // Создание бронирования на свободный слот.
  rpc CreateBooking (CreateBookingRequest) returns (CreateBookingResponse);

  // Получение информации о бронировании.
  rpc GetBooking (GetBookingRequest) returns (GetBookingResponse);

  // Отмена ранее созданного бронирования.
  rpc CancelBooking (CancelBookingRequest) returns (CancelBookingResponse);

  // Список бронирований клиента за период.
  rpc ListBookings (ListBookingsRequest) returns (ListBookingsResponse);

  // Получение расписаний провайдера (повторяющиеся правила).
  rpc ListProviderSchedules (ListProviderSchedulesRequest) returns (ListProviderSchedulesResponse);

  // CRUD расписаний провайдера.
  rpc CreateProviderSchedule (CreateProviderScheduleRequest) returns (CreateProviderScheduleResponse);
  rpc UpdateProviderSchedule (UpdateProviderScheduleRequest) returns (UpdateProviderScheduleResponse);
  rpc DeleteProviderSchedule (DeleteProviderScheduleRequest) returns (DeleteProviderScheduleResponse);

  // CRUD слотов.
  rpc CreateSlot (CreateSlotRequest) returns (CreateSlotResponse);
  rpc UpdateSlot (UpdateSlotRequest) returns (UpdateSlotResponse);
  rpc DeleteSlot (DeleteSlotRequest) returns (DeleteSlotResponse);
}
